<!DOCTYPE html>
<html th:lang="${#locale.language}" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="#{app.title}">Dosya Yönetimi</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<div class="navbar">
    <a href="/" class="logo" th:text="#{app.title}">Dosya Yönetimi</a>
    <div class="menu">
        <div class="language-selector">
            <select onchange="changeLanguage(this.value)">
                <option value="tr" th:selected="${#locale.toString() == 'tr'}" th:text="#{language.tr}">Türkçe</option>
                <option value="en" th:selected="${#locale.toString() == 'en'}" th:text="#{language.en}">English</option>
            </select>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()">
            <i class="fas fa-sun" id="theme-icon"></i>
            <span id="theme-text" th:text="#{app.theme.light}">Tema Değiştir</span>
        </button>
        <div sec:authorize="!isAuthenticated()">
            <a href="/login" th:text="#{nav.login}">Giriş Yap</a>
            <a href="/register" th:text="#{nav.register}">Kayıt Ol</a>
        </div>
        <div sec:authorize="isAuthenticated()" class="auth-buttons">
            <button onclick="showUploadModal()" class="btn btn-primary" th:text="#{nav.upload}">Dosya Yükle</button>
            <button onclick="showCreateFolderModal()" class="btn btn-primary" th:text="#{nav.create.folder}">Klasör Oluştur</button>
            <form th:action="@{/logout}" method="post" class="logout-form">
                <button type="submit" class="logout-button" th:text="#{nav.logout}">Çıkış Yap</button>
            </form>
        </div>
    </div>
</div>

<div class="content">
    <div sec:authorize="isAuthenticated()" class="welcome-text">
        <span th:text="#{home.welcome(${#authentication.name})}">Hoş geldin!</span>
    </div>

    <div th:if="${message}" class="alert alert-info" th:text="${message}"></div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <div sec:authorize="!isAuthenticated()" class="empty-state">
        <h2 th:text="#{app.title}">Hoş Geldiniz</h2>
        <p th:text="#{home.please.login}">Dosyalarınızı görüntülemek için lütfen giriş yapın.</p>
        <a href="/login" class="btn btn-primary" th:text="#{nav.login}">Giriş Yap</a>
    </div>

    <div sec:authorize="isAuthenticated()">
        <div th:if="${files.empty and folders.empty}" class="empty-state">
            <h2 th:text="#{home.no.files}">Henüz Dosyanız Yok</h2>
            <p th:text="#{home.upload.prompt}">Dosya yüklemek için "Dosya Yükle" butonuna tıklayın.</p>
            <div class="action-buttons">
                <button onclick="showUploadModal()" class="btn btn-primary" th:text="#{nav.upload}">Dosya Yükle</button>
                <button onclick="showCreateFolderModal()" class="btn btn-primary" th:text="#{nav.create.folder}">Klasör Oluştur</button>
            </div>
        </div>

        <!-- Klasörler Bölümü -->
        <div th:if="${!folders.empty}" class="folders-section">
            <!-- Klasör yolu -->
            <div class="folder-path" th:if="${currentFolder != null}">
                <a href="/" class="path-item">
                    <i class="fas fa-home"></i> Ana Dizin
                </a>
                <th:block th:if="${currentFolder.parentFolder != null}">
                    <i class="fas fa-chevron-right"></i>
                    <a th:href="@{/folders/{id}(id=${currentFolder.parentFolder.id})}" 
                       th:text="${currentFolder.parentFolder.name}" class="path-item">
                        Üst Klasör
                    </a>
                </th:block>
                <i class="fas fa-chevron-right"></i>
                <span th:text="${currentFolder.name}" class="current-folder">Mevcut Klasör</span>
            </div>

            <h3>Klasörler</h3>
            <div class="folders-grid">
                <div th:each="folder : ${folders}" class="folder-item">
                    <a th:href="@{/folders/{id}(id=${folder.id})}" class="folder-content">
                        <i class="fas fa-folder"></i>
                        <span th:text="${folder.name}">Klasör Adı</span>
                    </a>
                    <div class="folder-actions">
                        <form th:action="@{/folders/{id}/delete(id=${folder.id})}" method="post" style="display: inline;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button type="submit" class="btn btn-danger btn-sm" 
                                    th:onclick="'return confirm(\'' + #{folder.delete.confirm} + '\')'">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dosyalar Tablosu -->
        <div th:if="${!files.empty}" class="files-section">
            <h3>Dosyalar</h3>
            <table class="files-table">
                <thead>
                    <tr>
                        <th th:text="#{table.filename}">Dosya Adı</th>
                        <th th:text="#{table.size}">Boyut</th>
                        <th th:text="#{table.upload.date}">Yükleme Tarihi</th>
                        <th th:text="#{table.actions}">İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="file : ${files}">
                        <td th:text="${file.originalFilename}"></td>
                        <td th:text="${#numbers.formatDecimal(file.size / 1024, 0, 2) + ' KB'}"></td>
                        <td th:text="${#temporals.format(file.uploadDate, 'dd/MM/yyyy HH:mm')}"></td>
                        <td class="action-buttons">
                            <button class="btn btn-info btn-sm"
                                    th:onclick="'showPreviewModal(' + ${file.id} + ')'"
                                    th:text="#{table.preview}">Önizle</button>
                            <a th:href="@{/uploads/{id}(id=${file.id})}" 
                               class="btn btn-primary btn-sm" download th:text="#{table.download}">İndir</a>
                            <button class="btn btn-primary btn-sm"
                                    th:attr="data-filename=${file.fileName}"
                                    onclick="showShareModal(this.getAttribute('data-filename'))"
                                    th:text="#{table.share}">Paylaş</button>
                            <form th:action="@{/delete/{id}(id=${file.id})}" method="post" style="display: inline;">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <button type="submit" class="btn btn-danger btn-sm" 
                                        th:onclick="'return confirm(\'' + #{table.delete.confirm} + '\')'"
                                        th:text="#{table.delete}">Sil</button>
                            </form>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div th:if="${totalPages > 1}" class="pagination">
            <a th:if="${currentPage > 0}" th:href="@{/(page=${currentPage - 1})}" 
               class="btn btn-primary" th:text="'&laquo; ' + #{pagination.previous}">Önceki</a>
            
            <span th:each="i: ${#numbers.sequence(0, totalPages - 1)}">
                <a th:if="${i != currentPage}" th:href="@{/(page=${i})}" 
                   class="btn btn-outline-primary" th:text="${i + 1}"></a>
                <span th:if="${i == currentPage}" class="btn btn-primary" th:text="${i + 1}"></span>
            </span>
            
            <a th:if="${currentPage < totalPages - 1}" th:href="@{/(page=${currentPage + 1})}" 
               class="btn btn-primary" th:text="#{pagination.next} + ' &raquo;'">Sonraki</a>
        </div>
    </div>
</div>

<div id="shareModal" class="share-modal">
    <div class="modal-content">
        <h3 th:text="#{share.title}">Dosya Paylaş</h3>
        <form action="/share" method="post">
            <input type="hidden" id="shareFilename" name="filename">
            <input type="email" name="email" th:placeholder="#{share.email}" required>
            <div class="modal-buttons">
                <button type="button" class="btn btn-danger" onclick="hideShareModal()" th:text="#{share.cancel}">İptal</button>
                <button type="submit" class="btn btn-primary" th:text="#{share.button}">Paylaş</button>
            </div>
        </form>
    </div>
</div>

<!-- Dosya Yükleme Modal -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <h3 th:text="#{upload.title}">Dosya Yükle</h3>
        <form th:if="${currentFolder != null}" 
              th:action="@{/folders/{id}/upload(id=${currentFolder.id})}" 
              method="post" 
              enctype="multipart/form-data">
            <div class="form-group">
                <label for="file">Dosya Seç</label>
                <input type="file" class="form-control-file" id="file" name="file" required>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-danger" onclick="hideUploadModal()" th:text="#{upload.cancel}">İptal</button>
                <button type="submit" class="btn btn-primary" th:text="#{upload.submit}">Yükle</button>
            </div>
        </form>
        <form th:if="${currentFolder == null}" 
              th:action="@{/}" 
              method="post" 
              enctype="multipart/form-data">
            <div class="form-group">
                <label for="file">Dosya Seç</label>
                <input type="file" class="form-control-file" id="file" name="file" required>
            </div>
            
            <div class="form-group">
                <label for="folderId">Klasör Seç</label>
                <select class="form-control" id="folderId" name="folderId">
                    <option value="">Ana Klasör</option>
                    <option th:each="folder : ${folders}"
                            th:value="${folder.id}"
                            th:text="${folder.name}">
                    </option>
                </select>
            </div>
            
            <div class="modal-buttons">
                <button type="button" class="btn btn-danger" onclick="hideUploadModal()" th:text="#{upload.cancel}">İptal</button>
                <button type="submit" class="btn btn-primary" th:text="#{upload.submit}">Yükle</button>
            </div>
        </form>
    </div>
</div>

<!-- Klasör Oluşturma Modal -->
<div id="createFolderModal" class="modal">
    <div class="modal-content">
        <h3 th:text="#{folder.create.title}">Yeni Klasör</h3>
        <form th:action="@{/folders/create}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div class="form-group">
                <label for="folderName">Klasör Adı</label>
                <input type="text" class="form-control" id="folderName" name="name" required>
            </div>
            
            <div class="form-group">
                <label for="parentFolderId">Üst Klasör</label>
                <select class="form-control" id="parentFolderId" name="parentId">
                    <option value="">Ana Klasör</option>
                    <option th:each="folder : ${folders}"
                            th:value="${folder.id}"
                            th:text="${folder.name}">
                    </option>
                </select>
            </div>
            
            <div class="modal-buttons">
                <button type="button" class="btn btn-danger" onclick="hideCreateFolderModal()" th:text="#{folder.create.cancel}">İptal</button>
                <button type="submit" class="btn btn-primary" th:text="#{folder.create.submit}">Oluştur</button>
            </div>
        </form>
    </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="modal">
    <div class="modal-content preview-modal-content">
        <div class="modal-header">
            <h3 id="previewTitle" th:text="#{preview.title}">Dosya Önizleme</h3>
            <button type="button" class="close" onclick="hidePreviewModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="previewContent"></div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    // Dil değiştirme fonksiyonu
    function changeLanguage(lang) {
        const url = new URL(window.location.href);
        url.searchParams.set('lang', lang);
        window.location.href = url.toString();
    }

    // Tema tercihi için localStorage kullan
    function setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        
        // Icon ve metin güncelleme
        const themeIcon = document.getElementById('theme-icon');
        const themeText = document.getElementById('theme-text');
        
        if (theme === 'dark') {
            themeIcon.className = 'fas fa-moon';
            themeText.textContent = /*[[#{app.theme.dark}]]*/ 'Açık Mod';
        } else {
            themeIcon.className = 'fas fa-sun';
            themeText.textContent = /*[[#{app.theme.light}]]*/ 'Koyu Mod';
        }
    }

    function toggleTheme() {
        const currentTheme = localStorage.getItem('theme') || 'light';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        setTheme(newTheme);
    }

    // Sayfa yüklendiğinde tema tercihini kontrol et
    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);
    });

    // Modal fonksiyonları
    function showShareModal(filename) {
        document.getElementById('shareModal').style.display = 'block';
        document.getElementById('shareFilename').value = filename;
    }

    function hideShareModal() {
        document.getElementById('shareModal').style.display = 'none';
    }

    function showUploadModal() {
        document.getElementById('uploadModal').style.display = 'flex';
    }

    function hideUploadModal() {
        document.getElementById('uploadModal').style.display = 'none';
    }

    function showCreateFolderModal() {
        document.getElementById('createFolderModal').style.display = 'flex';
    }

    function hideCreateFolderModal() {
        document.getElementById('createFolderModal').style.display = 'none';
    }

    // Modal dışına tıklandığında modalı kapat
    window.onclick = function(event) {
        var modals = document.getElementsByClassName('modal');
        for (var modal of modals) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    }

    function showPreviewModal(fileId) {
        const modal = document.getElementById('previewModal');
        const previewContent = document.getElementById('previewContent');
        const loadingText = /*[[#{preview.loading}]]*/ 'Yükleniyor...';
        
        // Show loading state
        previewContent.innerHTML = `<div class="text-center"><i class="fas fa-spinner fa-spin"></i> ${loadingText}</div>`;
        modal.style.display = 'flex';
        
        // Fetch preview
        fetch(`/preview/${fileId}`)
            .then(response => {
                const contentType = response.headers.get('content-type');
                if (contentType.includes('image/')) {
                    return response.blob().then(blob => {
                        const url = URL.createObjectURL(blob);
                        return `<img src="${url}" alt="Preview">`;
                    });
                } else if (contentType.includes('application/pdf')) {
                    return `<iframe src="/preview/${fileId}" style="width:100%; height:500px; border:none;"></iframe>`;
                } else if (contentType.includes('text/plain')) {
                    return response.text().then(text => `<pre>${text}</pre>`);
                } else if (contentType.includes('application/json')) {
                    return response.json().then(info => {
                        const nameLabel = /*[[#{preview.file.info.name}]]*/ 'Dosya Adı';
                        const typeLabel = /*[[#{preview.file.info.type}]]*/ 'Dosya Türü';
                        const sizeLabel = /*[[#{preview.file.info.size}]]*/ 'Boyut';
                        const notSupportedText = /*[[#{preview.not.supported}]]*/ 'Bu dosya türü önizleme için uygun değil.';
                        
                        return `<div class="file-info">
                            <p><strong>${nameLabel}:</strong> ${info.filename}</p>
                            <p><strong>${typeLabel}:</strong> ${info.fileType}</p>
                            <p><strong>${sizeLabel}:</strong> ${formatFileSize(info.size)}</p>
                            <p>${notSupportedText}</p>
                        </div>`;
                    });
                }
            })
            .then(content => {
                previewContent.innerHTML = content;
            })
            .catch(error => {
                const errorTemplate = /*[[#{preview.error}]]*/ 'Önizleme yüklenirken bir hata oluştu: {0}';
                const errorMessage = errorTemplate.replace('{0}', error.message);
                previewContent.innerHTML = `<div class="preview-error">${errorMessage}</div>`;
            });
    }

    function hidePreviewModal() {
        const modal = document.getElementById('previewModal');
        modal.style.display = 'none';
        document.getElementById('previewContent').innerHTML = '';
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
</script>

<style>
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background-color: var(--bg-secondary);
    padding: 2rem;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
}

.form-control {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background-color: var(--input-bg);
    color: var(--text-primary);
}

.modal-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-top: 1rem;
}

.action-buttons {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
}

.folders-section {
    margin-bottom: 2rem;
}

.folders-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.folder-item {
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
}

.folder-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.folder-content {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.folder-content i {
    color: #ffd700;
    font-size: 1.5rem;
}

.files-section {
    margin-top: 2rem;
}

h3 {
    color: var(--text-primary);
    margin-bottom: 1rem;
    font-size: 1.5rem;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.folder-path {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    padding: 0.5rem;
    background-color: var(--bg-secondary);
    border-radius: 4px;
}

.path-item {
    color: var(--text-primary);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.path-item:hover {
    color: var(--btn-primary-bg);
}

.current-folder {
    color: var(--text-secondary);
}

.folder-content {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    color: var(--text-primary);
    flex-grow: 1;
}

.folder-content:hover {
    color: var(--btn-primary-bg);
}

.preview-modal-content {
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-primary);
}

.close:hover {
    color: var(--btn-danger-bg);
}

#previewContent {
    padding: 1rem;
}

#previewContent img {
    max-width: 100%;
    height: auto;
}

#previewContent pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    background-color: var(--bg-secondary);
    padding: 1rem;
    border-radius: 4px;
    max-height: 500px;
    overflow-y: auto;
}

.preview-error {
    color: var(--btn-danger-bg);
    padding: 1rem;
    text-align: center;
}
</style>

</body>
</html>
